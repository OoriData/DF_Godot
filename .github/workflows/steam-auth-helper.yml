name: Steam Auth Helper

on:
  push:
    branches: [ "CI-CD" ] # Triggers automatically when you push to this branch

env:
  # CHANGE THIS to your Steam username
  STEAM_USERNAME: "oori_builder"
  # PASTE YOUR CODE HERE before pushing
  STEAM_GUARD_CODE: "YBQFX"

jobs:
  capture-session:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SteamCMD
        uses: RageAgainstThePixel/setup-steamcmd@v1

      - name: Perform Login
        env:
          STEAM_USERNAME: ${{ env.STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
          STEAM_GUARD_CODE: ${{ env.STEAM_GUARD_CODE }}
        run: |
          export STEAM_HOME="/home/runner/steam_session"
          mkdir -p "$STEAM_HOME"
          
          echo "Starting login process..."
          if [ "$STEAM_GUARD_CODE" != "YOUR_CODE_HERE" ] && [ ! -z "$STEAM_GUARD_CODE" ]; then
            # Attempt login with provided code
            HOME="$STEAM_HOME" steamcmd +set_steam_guard_code "$STEAM_GUARD_CODE" +login "$STEAM_USERNAME" "$STEAM_PASSWORD" +quit
          else
            echo "ERROR: Please edit the STEAM_GUARD_CODE in the YAML file before pushing."
            exit 1
          fi

      - name: Generate Base64 Payloads
        if: success()
        run: |
          export STEAM_HOME="/home/runner/steam_session"
          echo "### PAYLOADS START ###"
          
          echo "--- STEAM_CONFIG_VDF ---"
          # Check both common linux paths
          VDF_FILE=$(find "$STEAM_HOME" -name "config.vdf" | head -n 1)
          if [ ! -z "$VDF_FILE" ]; then
            base64 -w 0 "$VDF_FILE"
          else
             echo "config.vdf not found"
          fi
          echo ""
          
          echo "--- STEAM_SSFN_FILE_BASE64 ---"
          SSFN_FILE=$(find "$STEAM_HOME" -name "ssfn*" | head -n 1)
          if [ ! -z "$SSFN_FILE" ]; then
            base64 -w 0 "$SSFN_FILE"
          else
            echo "No SSFN file found."
          fi
          
          echo ""
          echo "### PAYLOADS END ###"
