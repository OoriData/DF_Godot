name: Build macOS App Store

on:
  workflow_call:
    inputs:
      godot_version:
        required: true
        type: string
        default: '4.6.0'
      version_tag:
        required: true
        type: string
    secrets:
      APP_STORE_CONNECT_API_KEY:
        required: true
      APP_STORE_CONNECT_KEY_ID:
        required: true
      APP_STORE_CONNECT_ISSUER_ID:
        required: true
      MATCH_PASSWORD:
        required: true
      MATCH_GIT_URL:
        required: true
      GIT_TOKEN:
        required: true
      APPLE_DISTRIBUTION_P12:
        required: true
    outputs:
      build_status:
        description: 'Build success/failure'
        value: ${{ jobs.build.outputs.status }}

jobs:
  build:
    runs-on: macos-latest
    outputs:
      status: ${{ steps.export.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
        
      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ inputs.godot_version }}
          use-dotnet: false
          include-templates: true
          
      - name: Setup Keychain
        run: |
          security create-keychain -p actions temp.keychain
          security default-keychain -s temp.keychain
          security unlock-keychain -p actions temp.keychain
          security set-keychain-settings -t 3600 -u temp.keychain
          security list-keychains -d user -s temp.keychain login.keychain-db

      - name: Import Apple Distribution Certificate
        env:
          P12_BASE64: ${{ secrets.APPLE_DISTRIBUTION_P12 }}
        run: |
          echo "$P12_BASE64" | base64 --decode > /tmp/apple_dist.p12
          echo "=== Verifying .p12 contents ==="
          openssl pkcs12 -in /tmp/apple_dist.p12 -passin pass: -nokeys -info 2>&1 | head -10 || true
          echo "=== Checking for private key ==="
          openssl pkcs12 -in /tmp/apple_dist.p12 -passin pass: -nocerts -nodes 2>&1 | head -5 || true
          echo "=== Importing into keychain ==="
          security import /tmp/apple_dist.p12 -k temp.keychain -P "" -T /usr/bin/codesign -T /usr/bin/productbuild -T /usr/bin/security
          rm /tmp/apple_dist.p12
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions temp.keychain

      - name: Configure SSH for Match
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MATCH_SSH_KEY }}

      - name: Fastlane Match (macOS)
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          MATCH_KEYCHAIN_NAME: 'temp.keychain'
          MATCH_KEYCHAIN_PASSWORD: 'actions'
        run: |
          # Ensure Fastlane is up to date to support mac_installer
          bundle update fastlane
          # Sync certificates using the Fastfile lane (handles both appstore and installer certs)
          bundle exec fastlane mac sync_certificates

      - name: Allow Codesign Access to Keys
        run: |
          security unlock-keychain -p actions temp.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions temp.keychain

      - name: Inject Signing Configuration
        run: |
          python3 -c '
          import re
          import os
          import sys
          
          # Read project.godot for the "Short Version" (config/version)
          short_version = "1.0.0" # Fallback
          with open("project.godot", "r") as f:
              godot_content = f.read()
              match = re.search(r"config/version=\"([^\"]+)\"", godot_content)
              if match:
                  short_version = match.group(1)
          with open("export_presets.cfg", "r") as f:
              content = f.read()
          
          # Dynamically find the preset index for "macOS (App Store)"
          preset_match = re.search(r"^\[preset\.(\d+)\]\s+name=\"macOS \(App Store\)\"", content, re.MULTILINE)
          if not preset_match:
              print("Error: Could not find preset named \"macOS (App Store)\"")
              sys.exit(1)
          
          preset_index = preset_match.group(1)
          print(f"Found \"macOS (App Store)\" at index {preset_index}")
          
          # Match the options section for this preset
          section_regex = r"(\[preset\." + preset_index + r"\.options\].*?)(?=\n\[|$)"
          
          def set_key(match):
              section = match.group(1)
              profile_path = "Oori_Data_Desolate_Frontiers_Mac_App_Store.provisionprofile"
              # Build number logic: base + run_number * 10 + run_attempt
              build_number = str(100 + (int(os.environ["GITHUB_RUN_NUMBER"]) * 10) + int(os.environ["GITHUB_RUN_ATTEMPT"]))
              
              overrides = {
                  "codesign/provisioning_profile": f"\"{profile_path}\"",
                  "application/version": f"\"{build_number}\"",
                  "application/short_version": f"\"{short_version}\"",
                  "codesign/identity": "\"Apple Distribution: Oori Data LLC (3XQ7W4UW9M)\"",
                  "codesign/installer_identity": "\"3rd Party Mac Developer Installer: Oori Data LLC (3XQ7W4UW9M)\""
              }
              
              for key, val in overrides.items():
                  if f"{key}=" in section:
                      section = re.sub(f"{re.escape(key)}=.*", f"{key}={val}", section)
                  else:
                      section += f"\n{key}={val}"
              return section
          new_content = re.sub(section_regex, set_key, content, flags=re.DOTALL)
          with open("export_presets.cfg", "w") as f:
              f.write(new_content)
          '
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}

      - name: Install Apple WWDR Intermediate Certificates
        run: |
          curl -O https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer
          sudo security import AppleWWDRCAG3.cer -k temp.keychain -T /usr/bin/codesign -T /usr/bin/productbuild || true
          curl -O https://www.apple.com/certificateauthority/AppleWWDRCAG4.cer
          sudo security import AppleWWDRCAG4.cer -k temp.keychain -T /usr/bin/codesign -T /usr/bin/productbuild || true
          
      - name: Build with Godot (Export)
        id: export
        run: |
          mkdir -p build/macos-store
          # Export to .pkg for Mac App Store
          godot --headless --export-release "macOS (App Store)" "build/macos-store/Desolate_Frontiers.pkg"

      - name: Upload to App Store
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          bundle exec fastlane mac release
