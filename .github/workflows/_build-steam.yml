name: Build Steam

on:
  workflow_call:
    inputs:
      godot_version:
        required: true
        type: string
        default: '4.6.0'
      version_tag:
        required: true
        type: string
    secrets:
      STEAM_USERNAME:
        required: true
      STEAM_PASSWORD:
        required: true
      STEAM_CONFIG_VDF:
        required: false
      STEAM_APP_ID:
        required: true
      STEAM_DEPOT_ID_WINDOWS:
        required: true
      STEAM_DEPOT_ID_MACOS:
        required: true
    outputs:
      build_status:
        description: 'Build success/failure'
        value: ${{ jobs.deploy.outputs.status }}

jobs:
  build_windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ inputs.godot_version }}
          use-dotnet: false
          include-templates: true

      - name: Export Windows
        run: |
          mkdir -p build/windows
          godot --headless --export-release "Windows Desktop (x86)" build/windows/Desolate_Frontiers.exe
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: steam-build-windows
          path: build/windows

  build_macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ inputs.godot_version }}
          use-dotnet: false
          include-templates: true

      - name: Export macOS
        run: |
          mkdir -p build/macos
          godot --headless --export-release "macOS" build/macos/Desolate_Frontiers.zip
          
      - name: Extract macOS Zip
        run: |
          # 7z x preserves directory structure better than unzip for Mac apps sometimes, but unzip is standard.
          # The key is preserving specific macos permissions/symlinks which implies we might want to unzip on macos runner?
          # But we are on linux runner.
          # Steam expects the folder structure of .app
          # The godot-ci action usually outputs a zip for macOS.
          
          cd build/macos
          unzip Desolate_Frontiers.zip
          rm Desolate_Frontiers.zip
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: steam-build-macos
          path: build/macos

  deploy:
    needs: [build_windows, build_macos]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: steam-build-windows
          path: build/windows
          
      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: steam-build-macos
          path: build/macos
          
      - name: Setup SteamCMD
        uses: RageAgainstThePixel/setup-steamcmd@v1
        
      - name: Deploy to Steam
        env:
          STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
          STEAM_CONFIG_VDF: ${{ secrets.STEAM_CONFIG_VDF }}
          STEAM_SSFN_FILE_BASE64: ${{ secrets.STEAM_SSFN_FILE_BASE64 }}
        run: |
          # Define an isolated Steam directory to avoid session pollution.
          export STEAM_HOME="$(pwd)/steam_home"
          
          # MacOS SteamCMD path structure: ~/Library/Application Support/Steam/config/config.vdf
          # We replicate this inside our isolated STEAM_HOME
          mkdir -p "$STEAM_HOME/Library/Application Support/Steam/config"
          
          # 1. Place the config.vdf
          if [ ! -z "$STEAM_CONFIG_VDF" ]; then
             echo "$STEAM_CONFIG_VDF" | base64 --decode > "$STEAM_HOME/Library/Application Support/Steam/config/config.vdf"
             echo "Placed config.vdf in $STEAM_HOME/Library/Application Support/Steam/config"
          fi
          
          # 2. Place sentry file if provided
          if [ ! -z "$STEAM_SSFN_FILE_BASE64" ]; then
             echo "$STEAM_SSFN_FILE_BASE64" | base64 --decode > "$STEAM_HOME/Library/Application Support/Steam/ssfn_ci_auth"
          fi
          
          # 3. Inject IDs into VDFs
          sed -i '' "s/YOUR_APP_ID/${{ secrets.STEAM_APP_ID }}/g" steam_scripts/app_build.vdf
          sed -i '' "s/YOUR_DEPOT_ID_WINDOWS/${{ secrets.STEAM_DEPOT_ID_WINDOWS }}/g" steam_scripts/app_build.vdf
          sed -i '' "s/YOUR_DEPOT_ID_MACOS/${{ secrets.STEAM_DEPOT_ID_MACOS }}/g" steam_scripts/app_build.vdf
          
          sed -i '' "s/YOUR_DEPOT_ID_WINDOWS/${{ secrets.STEAM_DEPOT_ID_WINDOWS }}/g" steam_scripts/depot_build_windows.vdf
          sed -i '' "s/YOUR_DEPOT_ID_MACOS/${{ secrets.STEAM_DEPOT_ID_MACOS }}/g" steam_scripts/depot_build_macos.vdf

          # 4. Run the build with the isolated HOME
          HOME="$STEAM_HOME" steamcmd +login $STEAM_USERNAME $STEAM_PASSWORD +run_app_build $(pwd)/steam_scripts/app_build.vdf +quit

      - name: Self-Healing Steam Auth (Rotate Secret)
        if: success()
        env:
          GH_TOKEN: ${{ secrets.STEAM_SECRET_UPDATER_PAT }}
          STEAM_HOME: ${{ github.workspace }}/steam_home
        run: |
          echo "Rotating Steam Config Secret..."
          
          # MacOS Path
          CONFIG_PATH="$STEAM_HOME/Library/Application Support/Steam/config/config.vdf"
          
          if [ ! -f "$CONFIG_PATH" ]; then
            echo "::error::Config file not found at expected path: $CONFIG_PATH"
            exit 1
          fi
          
          # Encode with -w 0 (linux) or just normal base64 on mac (no -w option usually needed or available differently)
          # MacOS base64 doesn't have -w 0, it behaves differently. 
          # We use openssl or Python for reliable cross-platform base64 encoding without newlines.
          
          python3 -c "import base64; print(base64.b64encode(open('$CONFIG_PATH', 'rb').read()).decode('utf-8'))" | gh secret set STEAM_CONFIG_VDF --body -
          
          echo "âœ… Secret STEAM_CONFIG_VDF rotated successfully."
